# 开放世界沙盒



本章将为您简要介绍地图关卡相关的内容，更详细的使用说明，请参阅后续章节。



### 地图逻辑

引擎能够将多个地图无缝拼接，并流畅地呈现给玩家，营造出开放世界的体验。仅有玩家视野范围内的地图块会被渲染，进入画面的实体会被动态加载，而离开画面的实体则会被自动卸载。

各类地图块的功能如下：

- **背景块**：仅用于视觉展示，不参与碰撞计算。
- **关卡块**：默认具有碰撞效果。通过添加“单向板”标签，可设置为仅在特定方向上阻挡实体通过。
- **实体块**：用于加载包含用户自定义逻辑的实例，通常代表具有行为的游戏对象。
- **辅助块**：仅存在于后台数据中，不参与渲染，也不产生交互，用于标记或内部逻辑用途。

<img src="../../images/OpenWorldSandbox-Map.png" width="61.8%"/>




### 地图层

玩家可使用门或传送门前往相邻的地图层（如下图），引擎会在游戏进行时显示相邻的后置层。使用 `TeleportTask.TeleportFromDoor` 方法来传送玩家角色。

<img src="../../images/GoThroughLayer.gif" width="61.8%"/>




### 地图文件

地图文件格式为 `ibb` 意为 `int byte byte`，每个`ibb`文件储存着 128 × 128 (块) 尺寸的地图，文件名为对应正方形区域的左下角的 x_y_z 坐标。文件内容为 int, byte, byte 为一组所串成的列表（例如 7126723, 0, 0, -467174, 1, 0, 892135, 2, 1,...），其中 int 为块名称的`AngeHash` ，第一个 byte 为块在地图内的本地 x 坐标，第二个 byte 为 y 坐标。当坐标超过 127 时，需将数值减去 128 得到真实数据。当 x\<128  y\<128 时，块为实体类型；当 x\<128  y≥128 时，块为辅助类型；当 x≥128  y\<128 时，块为关卡类型；当 x≥128  y≥128 时，块为背景类型；

<img src="../../images/OpenWorldSandbox-MapFile.png" width="61.8%"/>

